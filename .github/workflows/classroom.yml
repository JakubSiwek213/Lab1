name: Autograding Tests

on:
  - push
  - repository_dispatch

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'github-classroom[bot]' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # --- Restore (bez punktów) ---
      - name: Restore
        id: restore
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: Restore
          setup-command: ''
          command: |
            dotnet restore ./Lab1_Task.ConsoleApp/Lab1_Task.ConsoleApp.csproj
            dotnet restore ./Lab1_Task.Tests/Lab1_Task.Tests.csproj
          timeout: 60
          max-score: 0

      # --- Build (bez punktów) ---
      - name: Build
        id: build
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: Build
          setup-command: ''
          command: |
            dotnet build ./Lab1_Task.ConsoleApp/Lab1_Task.ConsoleApp.csproj -c Release --no-restore
            dotnet build ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-restore
          timeout: 60
          max-score: 0

      # ================== PUNKTOWANE TESTY (1 pkt każdy) ==================

      # ---- STRUKTURA (S01–S11) ----
      - name: S01 - Class exists (public)
        id: s01
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: S01_ClassExists_Public
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.S01_ClassExists_Public" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: S02 - Prop AccountNumber
        id: s02
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: S02_Prop_AccountNumber_Exists
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.S02_Prop_AccountNumber_Exists" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: S03 - Prop OwnerName
        id: s03
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: S03_Prop_OwnerName_Exists
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.S03_Prop_OwnerName_Exists" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: S04 - Prop Balance (public getter)
        id: s04
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: S04_Prop_Balance_Exists
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.S04_Prop_Balance_Exists" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: S05 - Prop Currency
        id: s05
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: S05_Prop_Currency_Exists
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.S05_Prop_Currency_Exists" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: S06 - Prop IsActive
        id: s06
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: S06_Prop_IsActive_Exists
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.S06_Prop_IsActive_Exists" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: S07 - Props count >= 6
        id: s07
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: S07_Props_Count_AtLeast6
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.S07_Props_Count_AtLeast6" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: S08 - Fields count >= 5
        id: s08
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: S08_Fields_Count_AtLeast5
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.S08_Fields_Count_AtLeast5" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: S09 - Method Deposit exists
        id: s09
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: S09_Method_Deposit_Exists
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.S09_Method_Deposit_Exists" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: S10 - Method Withdraw exists
        id: s10
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: S10_Method_Withdraw_Exists
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.S10_Method_Withdraw_Exists" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: S11 - Method TransferTo exists (signature)
        id: s11
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: S11_Method_TransferTo_Exists_WithSignature
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.S11_Method_TransferTo_Exists_WithSignature" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      # ---- ZACHOWANIE (B01–B04) ----
      - name: B01 - Deposit increases Balance
        id: b01
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: B01_Deposit_Increases_Balance
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.B01_Deposit_Increases_Balance" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: B02 - Withdraw decreases Balance
        id: b02
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: B02_Withdraw_Decreases_Balance
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.B02_Withdraw_Decreases_Balance" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: B03 - TransferTo moves funds
        id: b03
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: B03_TransferTo_Moves_Funds
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.B03_TransferTo_Moves_Funds" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      - name: B04 - Withdraw too much does not change balance
        id: b04
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: B04_Withdraw_TooMuch_ShouldNotChangeBalance
          command: dotnet test ./Lab1_Task.Tests/Lab1_Task.Tests.csproj -c Release --no-build --filter "FullyQualifiedName=Lab1_Task.Tests.BankAccountTests.B04_Withdraw_TooMuch_ShouldNotChangeBalance" -l "console;verbosity=detailed"
          timeout: 30
          max-score: 1

      # --- Reporter: zbiera wyniki wszystkich runnerów ---
      - name: Autograding Reporter
        uses: classroom-resources/autograding-grading-reporter@v1
        with:
          runners: >-
            restore,build,
            s01,s02,s03,s04,s05,s06,s07,s08,s09,s10,s11,
            b01,b02,b03,b04
        env:
          RESTORE_RESULTS: ${{ steps.restore.outputs.result }}
          BUILD_RESULTS:   ${{ steps.build.outputs.result }}
          S01_RESULTS:     ${{ steps.s01.outputs.result }}
          S02_RESULTS:     ${{ steps.s02.outputs.result }}
          S03_RESULTS:     ${{ steps.s03.outputs.result }}
          S04_RESULTS:     ${{ steps.s04.outputs.result }}
          S05_RESULTS:     ${{ steps.s05.outputs.result }}
          S06_RESULTS:     ${{ steps.s06.outputs.result }}
          S07_RESULTS:     ${{ steps.s07.outputs.result }}
          S08_RESULTS:     ${{ steps.s08.outputs.result }}
          S09_RESULTS:     ${{ steps.s09.outputs.result }}
          S10_RESULTS:     ${{ steps.s10.outputs.result }}
          S11_RESULTS:     ${{ steps.s11.outputs.result }}
          B01_RESULTS:     ${{ steps.b01.outputs.result }}
          B02_RESULTS:     ${{ steps.b02.outputs.result }}
          B03_RESULTS:     ${{ steps.b03.outputs.result }}
          B04_RESULTS:     ${{ steps.b04.outputs.result }}
